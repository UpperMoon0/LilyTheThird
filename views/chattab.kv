#:kivy 2.0.0
#:import os os
#:import LLMSelector views.components.llm_selector.LLMSelector
#:import ChatboxSettings views.components.chatbox_settings.ChatboxSettings
#:import ChatBox views.components.chat_box.ChatBox
#:import CircularImage views.components.circular_image.CircularImage
#:import RGBStrip views.components.rgb_strip

<ChatTab>:
    orientation: 'vertical'
    padding: dp(10) # Adjusted padding
    spacing: dp(10) # Adjusted spacing

    # Add the RGB Strip at the very top
    RGBStrip:
        # Height is set in the component's Python code (3dp)
        # Width will automatically match the parent (ChatTab)

    # --- Row A: Avatar and Controls ---
    BoxLayout:
        id: row_a
        orientation: 'horizontal'
        size_hint_y: None
        height: dp(320) # Fixed height for the top section (adjust as needed)
        spacing: dp(10)

        # Column 1: Avatar (Using AnchorLayout for robust centering)
        AnchorLayout:
            id: col_1_avatar_anchor # Renamed id slightly
            anchor_x: 'center'
            anchor_y: 'center'
            size_hint_x: 0.4
            padding: dp(10) # Padding still applies

            CircularImage:
                source: 'assets/avatar.png'
                # Make it square and size based on available height
                size_hint: None, None
                # Calculate height based on parent's height minus padding
                # Note: parent is now AnchorLayout, height calculation remains similar conceptually
                # Let's tie it directly to the fixed height row_a minus padding for stability
                height: root.ids.row_a.height - dp(40) # row_a height - top/bottom padding of AnchorLayout - top/bottom padding of row_a
                width: self.height # Make it square
                # pos_hint no longer needed due to AnchorLayout

        # Column 2: Controls (Chat Controls + LLM Selector)
        BoxLayout:
            id: col_2_controls
            orientation: 'vertical'
            size_hint_x: 0.6 # Adjust size hint to complement avatar column
            # Make height wrap content instead of filling row_a
            size_hint_y: None
            height: self.minimum_height
            pos_hint: {'center_y': 0.5} # Center vertically in the row_a space
            spacing: dp(10)
            padding: dp(10) # Padding for the outer controls column

            # ChatboxSettings now contains LLMSelector
            ChatboxSettings:
                id: chat_controls
                # size_hint_y: 0.5 # REMOVED - Let it take its needed height
                # Pass LLM properties down to ChatboxSettings
                tts_enabled: root.tts_enabled
                llm_providers: root.llm_providers
                llm_models: root.llm_models
                selected_provider: root.selected_provider
                selected_model: root.selected_model
                # Handle events bubbling up
                on_clear_history: root.clear_history()
                on_tts_enabled: root.tts_enabled = self.tts_enabled
                on_selected_provider: root.selected_provider = self.selected_provider
                on_selected_model: root.selected_model = self.selected_model


    # --- Row B: ChatBox ---
    ChatBox:
        id: chat_box # Add id to reference from python code
        size_hint_y: 1 # Let ChatBox take the remaining vertical space
        # Bind ChatBox properties/events to ChatTab (root)
        backend_initialized: root.backend_initialized
        # Pass the prompt text argument from the event to the root method
        on_send_prompt: root.send_prompt(args[1]) # args[0] is the widget, args[1] is the prompt text
        on_toggle_recording: root.toggle_recording()
